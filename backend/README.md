# RTMP → RTSP Конвертер: Backend

Серверная часть приложения для конвертации видеопотоков из формата RTMP в формат RTSP.

## Описание

Этот сервис позволяет:

- Принимать видеопотоки в формате RTMP
- Конвертировать их в формат RTSP
- Предоставлять доступ к RTSP-потокам
- Управлять несколькими потоками одновременно
- Предоставлять REST API для управления потоками

## Технологии

- **Node.js 18** с **TypeScript**
- **Express** для REST API
- **node-media-server** для приема RTMP потоков
- **Winston** для логирования
- **dotenv** для управления конфигурацией
- **uuid** для генерации уникальных идентификаторов

## Структура проекта

```
./
├── config/          # Конфигурационные файлы
├── controllers/      # Контроллеры для обработки HTTP запросов
├── models/          # Модели данных
├── routes/          # Определение маршрутов API
├── services/        # Сервисы для работы с видеопотоками
│   ├── rtmp-server.ts # RTMP сервер на основе node-media-server
│   ├── converter.ts   # Конвертер потоков на основе FFmpeg
│   └── stream-manager.ts # Управление потоками
├── utils/           # Вспомогательные утилиты
├── app.ts           # Главный файл приложения
├── env.d.ts         # Определения типов для переменных окружения
├── package.json     # Настройки проекта и зависимости
└── tsconfig.json    # Конфигурация TypeScript
```

## Основные компоненты

### RtmpServer

Обертка над `node-media-server`, которая принимает RTMP потоки на порту 1935.

### Converter

Сервис, использующий `MediaMTX` для конвертации RTMP потоков в RTSP формат.

### StreamManager

Управляет потоками: создание, запуск, остановка, удаление, отслеживание статуса.

### StreamController

Обрабатывает HTTP запросы для управления потоками через REST API.

## API Интерфейс

### Получение всех потоков

`GET /api/streams`

### Создание нового потока

`POST /api/streams`

### Получение информации о потоке

`GET /api/streams/:id`

### Запуск потока

`POST /api/streams/:id/start`

### Остановка потока

`POST /api/streams/:id/stop`

### Удаление потока

`DELETE /api/streams/:id`

## Запуск и разработка

### Запуск с помощью Docker (рекомендуется)

Смотрите инструкции в корневом README.md.

### Локальный запуск для разработки

1. Установите зависимости:

   ```bash
   npm install
   ```

2. Соберите проект:

   ```bash
   npm run build
   ```

3. Запустите сервер:
   ```bash
   npm start
   ```

Сервер будет доступен по адресу `http://localhost:3000`.

## Переменные окружения

- `PORT` - порт для API (3000 по умолчанию)
- `RTMP_PORT` - порт для RTMP сервера (1935 по умолчанию)
- `RTSP_PORT` - порт для RTSP сервера (8554 по умолчанию)
- `HTTP_PORT` - порт для HLS (8888 по умолчанию)
- `LOG_LEVEL` - уровень логирования (info по умолчанию)
- `HOST` - хост для доступа к API (localhost по умолчанию)

## Требования

- Node.js (версия 16+)
- Docker и Docker Compose (опционально)

## Установка

### Локальная установка

1. Клонировать репозиторий:

```
git clone <repository-url>
cd rtmp-rtsp-converter
```

2. Установить зависимости:

```
npm install
```

3. Собрать проект:

```
npm run build
```

4. Запустить сервис:

```
npm start
```

### Установка с использованием Docker

1. Клонировать репозиторий:

```
git clone <repository-url>
cd rtmp-rtsp-converter
```

2. Запустить с помощью Docker Compose:

```
docker-compose up -d
```

## Использование

### Веб-интерфейс

После запуска сервиса, веб-интерфейс доступен по адресу:

```
http://localhost:3000
```

Через веб-интерфейс можно:

- Создавать новые потоки
- Управлять существующими потоками
- Получать RTMP и RTSP URL для каждого потока

### API

Сервис предоставляет REST API для управления потоками:

- `GET /api/streams` - получить список всех потоков
- `GET /api/streams/:id` - получить информацию о конкретном потоке
- `POST /api/streams` - создать новый поток
- `POST /api/streams/:id/start` - запустить конвертацию потока
- `POST /api/streams/:id/stop` - остановить конвертацию потока
- `DELETE /api/streams/:id` - удалить поток

### Отправка RTMP-потока

Для отправки RTMP-потока можно использовать OBS Studio или FFmpeg:

#### OBS Studio

1. Откройте OBS Studio
2. Перейдите в Настройки -> Вещание
3. Выберите "Пользовательский" сервис вещания
4. Введите URL сервера: `rtmp://localhost:1935/live`
5. Введите ключ потока, который был создан через веб-интерфейс или API

#### FFmpeg

```
ffmpeg -re -i <input-file-or-device> -c:v libx264 -preset veryfast -c:a aac -f flv rtmp://localhost:1935/live/<stream-key>
```

### Просмотр RTSP-потока

Для просмотра RTSP-потока можно использовать:

#### Встроенный веб-плеер

Веб-интерфейс включает встроенный RTSP-плеер с поддержкой WebRTC, который позволяет просматривать потоки прямо в браузере. Для использования:

1. Откройте страницу потока в веб-интерфейсе
2. Нажмите кнопку "Показать плеер" под RTSP URL
3. Плеер автоматически подключится к потоку, если он запущен

#### VLC

```
vlc rtsp://localhost:8554/live/<stream-key>
```

#### FFplay

```
ffplay rtsp://localhost:8554/live/<stream-key>
```

## Конфигурация

Конфигурация сервиса осуществляется через переменные окружения или файл `.env`:

- `PORT` - порт для веб-интерфейса (по умолчанию 3000)
- `RTMP_PORT` - порт для RTMP-сервера (по умолчанию 1935)
- `RTMP_CHUNK_SIZE` - размер чанка для RTMP (по умолчанию 60000)
- `RTSP_PORT` - порт для RTSP-сервера (по умолчанию 8554)
- `LOG_LEVEL` - уровень логирования (по умолчанию info)

## Архитектура

Сервис состоит из следующих компонентов:

1. **RTMP-сервер** - принимает входящие RTMP-потоки
2. **Конвертер** - преобразует RTMP в RTSP с помощью MediaMTX
3. **Менеджер потоков** - управляет несколькими потоками одновременно
4. **REST API** - предоставляет API для управления потоками
5. **Веб-интерфейс** - предоставляет пользовательский интерфейс для управления потоками

## Лицензия

ISC
